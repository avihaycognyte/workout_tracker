{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>Weekly Summary</h1>

    <div class="mb-3">
        <label for="method" class="form-label">Calculation Method:</label>
        <select id="method" class="form-select" onchange="updateSummary()">
            <option value="Total" {% if selected_method == "Total" %}selected{% endif %}>
                Total (Includes all primary, secondary, and tertiary contributions)
            </option>
            <option value="Fractional" {% if selected_method == "Fractional" %}selected{% endif %}>
                Fractional (Weighted contributions: primary (100%), secondary (50%), tertiary (0%))
            </option>
            <option value="Direct" {% if selected_method == "Direct" %}selected{% endif %}>
                Direct (Primary muscle group only)
            </option>
        </select>
    </div>

    <div class="table-responsive">
        <table class="table table-striped mt-4">
            <thead>
                <tr>
                    <th>Muscle Group</th>
                    <th>Total Sets</th>
                    <th>Total Reps</th>
                    <th>Total Weight</th>
                </tr>
            </thead>
            <tbody id="weekly-summary-table">
                <tr>
                    <td colspan="4" class="text-center text-muted">
                        Unable to fetch data. Please try again later.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <hr>
    <div id="explanation-index">
        <h5>Explanation of Calculation Methods</h5>
        <ul>
            <li><strong>Total:</strong> Includes contributions from the primary and secondary muscle groups, as well as a reduced contribution from tertiary muscle groups:
                <ul>
                    <li><strong>Primary:</strong> 100% of sets, reps, and weight.</li>
                    <li><strong>Secondary:</strong> 100% of sets, reps, and weight.</li>
                    <li><strong>Tertiary:</strong> 33% of sets, reps, and weight.</li>
                </ul>
            </li>
            <li><strong>Fractional:</strong> Weights contributions differently:
                <ul>
                    <li><strong>Primary:</strong> 100% of sets, reps, and weight.</li>
                    <li><strong>Secondary:</strong> 50% of sets, reps, and weight.</li>
                    <li><strong>Tertiary:</strong> 0% (excluded).</li>
                </ul>
            </li>
            <li><strong>Direct:</strong> Only considers the primary muscle group:
                <ul>
                    <li><strong>Primary:</strong> 100% of sets, reps, and weight.</li>
                    <li><strong>Secondary:</strong> 0% (excluded).</li>
                    <li><strong>Tertiary:</strong> 0% (excluded).</li>
                </ul>
            </li>
        </ul>
    </div>
</div>

<script>
async function updateSummary() {
    const method = document.getElementById("method").value;
    const tableBody = document.getElementById("weekly-summary-table");

    try {
        // Explicitly request JSON
        const response = await fetch(`/weekly_summary?method=${method}`, {
            headers: { "Accept": "application/json" },
        });
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        // Parse the response as JSON
        const data = await response.json();

        // Validate the data is an array
        if (!Array.isArray(data)) {
            throw new Error("Expected an array of summary data");
        }

        // Populate the table
        tableBody.innerHTML = data.length
            ? data.map(row => `
                <tr>
                    <td>${row.muscle_group || "N/A"}</td>
                    <td>${Number(row.total_sets).toFixed(1)}</td>
                    <td>${Number(row.total_reps).toFixed(1)}</td>
                    <td>${Number(row.total_weight).toFixed(1)}</td>
                </tr>`).join("")
            : `<tr><td colspan="4" class="text-center text-muted">No data available.</td></tr>`;
    } catch (error) {
        console.error("Error fetching weekly summary:", error);
        alert(`Error fetching data: ${error.message}`);
        tableBody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-danger">
                    Unable to fetch data. Please try again later.
                </td>
            </tr>`;
    }
}

// Initialize the summary on page load
document.addEventListener("DOMContentLoaded", updateSummary);

</script>
{% endblock %}
