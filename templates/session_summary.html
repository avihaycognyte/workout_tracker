{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>Per Session Summary</h1>

    <!-- Method Dropdown -->
    <div class="mb-3">
        <label for="method" class="form-label">Calculation Method</label>
        <select id="method" class="form-select" onchange="updateSessionSummary()">
            <option value="Total" selected>Total (All Contributions)</option>
            <option value="Fractional">Fractional (Weighted Contributions)</option>
            <option value="Direct">Direct (Primary Muscle Group Only)</option>
        </select>
    </div>

    <!-- Session Summary Table -->
    <div id="session-summary-container" class="table-responsive mt-4">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Routine</th>
                    <th>Muscle Group</th>
                    <th>Total Sets</th>
                    <th>Total Reps</th>
                </tr>
            </thead>
            <tbody id="session-summary-table">
                <tr>
                    <td colspan="4" class="text-center text-muted">Loading data...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // Function to Fetch and Update Per Session Summary
    async function updateSessionSummary() {
        const method = document.getElementById("method").value;
        const tableBody = document.getElementById("session-summary-table");

        tableBody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </td>
            </tr>`;

        try {
            const response = await fetch(`/session_summary?method=${method}`, {
                headers: { "Accept": "application/json" }
            });

            if (!response.ok) throw new Error("Failed to fetch session summary.");

            const data = await response.json();

            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted">No data available.</td>
                    </tr>`;
                return;
            }

            tableBody.innerHTML = data.map(row => `
                <tr>
                    <td>${row.routine}</td>
                    <td>${row.muscle_group || "N/A"}</td>
                    <td>${row.total_sets}</td>
                    <td>${row.total_reps}</td>
                </tr>
            `).join("");

        } catch (error) {
            console.error("Error fetching session summary:", error);
            tableBody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-danger">Failed to load data. Please try again later.</td>
                </tr>`;
        }
    }

    // Initialize Summary on Page Load
    document.addEventListener("DOMContentLoaded", updateSessionSummary);
</script>
{% endblock %}
