{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>Workout Plan</h2>

    <!-- Filters for Exercises -->
    <div class="filters">
        <h4>Filter Exercises</h4>
        <form id="filters-form" class="row">
            {% for filter_name, filter_options in filters.items() %}
            <div class="col-md-4">
                <label for="{{ filter_name }}" class="form-label">{{ filter_name }}</label>
                <select id="{{ filter_name }}" class="form-select">
                    <option value="">All</option>
                    {% for option in filter_options %}
                    <option value="{{ option }}">{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endfor %}
        </form>
        <button class="btn btn-primary mt-3" onclick="filterExercises()">Filter</button>
    </div>

    <!-- Exercise Selection and Form -->
    <div class="exercise-selection mt-4">
        <form id="add-exercise-form">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="routine" class="form-label">Routine</label>
                    <select id="routine" class="form-select">
                        {% for split_type, routines in routineOptions.items() %}
                        <optgroup label="{{ split_type }}">
                            {% for routine in routines %}
                            <option value="{{ routine }}">{{ routine }}</option>
                            {% endfor %}
                        </optgroup>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="exercise" class="form-label">Exercise</label>
                    <select id="exercise" class="form-select">
                        {% for exercise in exercises %}
                        <option value="{{ exercise }}">{{ exercise }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="sets" class="form-label">Sets</label>
                    <input type="number" id="sets" class="form-control" min="1" value="1">
                </div>
                <div class="col-md-2">
                    <label for="rir" class="form-label">RIR</label>
                    <input type="number" id="rir" class="form-control" min="0" value="2">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="min_rep_range" class="form-label">Min Rep Range</label>
                    <input type="number" id="min_rep_range" class="form-control" min="1" value="3">
                </div>
                <div class="col-md-4">
                    <label for="max_rep_range" class="form-label">Max Rep Range</label>
                    <input type="number" id="max_rep_range" class="form-control" min="1" value="5">
                </div>
                <div class="col-md-4">
                    <label for="weight" class="form-label">Weight</label>
                    <input type="number" id="weight" class="form-control" min="0" value="100">
                </div>
            </div>
            <button type="button" class="btn btn-success" onclick="addExercise()">Add Exercise</button>
        </form>
    </div>

    <!-- Display the Workout Plan -->
    <div class="workout-plan mt-4">
        <h4>Your Workout Plan</h4>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Routine</th>
                    <th>Exercise</th>
                    <th>Primary Muscle Group</th>
                    <th>Secondary Muscle Group</th>
                    <th>Tertiary Muscle Group</th>
                    <th>Sets</th>
                    <th>Min Rep Range</th>
                    <th>Max Rep Range</th>
                    <th>RIR</th>
                    <th>Weight</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="workout-plan-table">
                {% for i, selection in enumerate(user_selection) %}
                <tr>
                    <td>{{ i + 1 }}</td>
                    <td>{{ selection.routine }}</td>
                    <td>{{ selection.exercise }}</td>
                    <td>{{ selection.primary_muscle_group }}</td>
                    <td>{{ selection.secondary_muscle_group }}</td>
                    <td>{{ selection.tertiary_muscle_group }}</td>
                    <td>{{ selection.sets }}</td>
                    <td>{{ selection.min_rep_range }}</td>
                    <td>{{ selection.max_rep_range }}</td>
                    <td>{{ selection.rir }}</td>
                    <td>{{ selection.weight }}</td>
                    <td>
                        <button class="btn btn-danger btn-sm"
                            onclick="removeExercise('{{ selection.routine }}', '{{ selection.exercise }}')">Remove</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Export Button -->
    <div class="export-section mt-3">
        <button class="btn btn-primary" onclick="exportToExcel()">Export to Excel</button>
    </div>
</div>

<script>
    // Export to Excel
    function exportToExcel() {
        window.location.href = "/export_to_excel";
    }

    function filterExercises() {
        const filters = {
            primary_muscle_group: document.getElementById("Primary Muscle Group").value,
            secondary_muscle_group: document.getElementById("Secondary Muscle Group").value,
            tertiary_muscle_group: document.getElementById("Tertiary Muscle Group").value,
            force: document.getElementById("Force").value,
            equipment: document.getElementById("Equipment").value,
            mechanic: document.getElementById("Mechanic").value,
            difficulty: document.getElementById("Difficulty").value,
        };

        fetch("/filter_exercises", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(filters),
        })
        .then(response => response.json())
        .then(data => {
            const exerciseDropdown = document.getElementById("exercise");
            exerciseDropdown.innerHTML = "";
            data.forEach(exercise => {
                const option = document.createElement("option");
                option.value = exercise;
                option.textContent = exercise;
                exerciseDropdown.appendChild(option);
            });
        })
        .catch(error => console.error("Error filtering exercises:", error));
    }

    function addExercise() {
        const data = {
            routine: document.getElementById("routine").value,
            exercise: document.getElementById("exercise").value,
            sets: document.getElementById("sets").value,
            min_rep_range: document.getElementById("min_rep_range").value,
            max_rep_range: document.getElementById("max_rep_range").value,
            rir: document.getElementById("rir").value,
            weight: document.getElementById("weight").value,
        };

        fetch("/add_exercise", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            location.reload();
        })
        .catch(error => console.error("Error adding exercise:", error));
    }

    function removeExercise(routine, exercise) {
        fetch("/remove_exercise", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ routine, exercise }),
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            location.reload();
        })
        .catch(error => console.error("Error removing exercise:", error));
    }
</script>
{% endblock %}